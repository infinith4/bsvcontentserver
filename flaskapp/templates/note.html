{% extends "layout.html" %}
{% include "header.html" %}

{% block content %}
<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
  <script>
    $(function(){
        var address = $('#address').text()
        var transaction_count_str = $('input#transaction_count').val()
        var transaction_count = parseInt(transaction_count_str)
        var percnt = 5
        var current_transaction_index = 0;

        var slide = $('#slide');
        var contents = $('#slide-contents');
        //開くボタン
        var openBtn = $('#open-btn img');
        var btnOpenFlug = false;
        var openFlug = false;
        var panelSwitch = function() {
            //閉じる
            if (openFlug == true ) {
                slide.stop().animate({'width' : '200px','height' : '30px'}, 500); 
                openBtn.show();		//開くボタンにする
                $.ajax({
                    type: "GET",
                    url: "/api/tx/" + address + "?start_index=" + current_transaction_index + "&cnt=" + percnt,
                    dataType: "json",
                    success: function(jsondata){
                        $.each( jsondata['textdata_list'], function( index, value ) {
                            content = '<div class="mt-1 mb-1 border-bottom" id="textdata_' + current_transaction_index + '"><p class="text-left">' + value + '</p></div>';
                            $('.textdata_list').append(content);
                            current_transaction_index += index + 1
                        });
                    }
                });
            }
            //開く
            else if (openFlug == false) {
                slide.stop().animate({'width' : '400px','height' : '200px'}, 500); 
                openBtn.hide();		//閉じるボタンにする
            }
        };
        //開くボタンクリックしたら
        $('#open-btn').click(function(){
            panelSwitch();
            openFlug = !openFlug;
            btnOpenFlug = true;
        });
        //画面下位置を取得
        var bottomPos = $(document).height() - $(window).height() - 500;
        $(window).scroll(function () {
            if (!btnOpenFlug) {
                if ($(this).scrollTop() >= bottomPos) {
                    if (openFlug == false) {
                        panelSwitch();
                        openFlug = true;
                    }
                } else {
                    if (openFlug) {
                        panelSwitch();
                        openFlug = false;
                    }
                }
            }
        });
    });
  </script>
<div class="form">
    <div class="container">
        <div class="pb-2 mt-4 mb-2 border-bottom">
            <h4>Note(testnet)</h4>
        </div>
        <label id="address">{{address}}</label>
        <input id="transaction_count" type='text' value='{{transaction_count}}' />
        <div>
            {% if error_msg %}
            <div class="alert alert-danger" role="alert">
                {{error_msg}} <a href="#" class="alert-link">show help</a>
            </div>
            {% endif %}
        </div>
        <form method ="post" enctype = "multipart/form-data">
            <div class="form-group">
                <label for="mnemonic_words">mnemonic words</label>
                <input type="text" name = "mnemonic_words" class="form-control">
                <label for="message">message</label>
                <textarea name = "message" rows="6" cols="40" class="form-control" maxlength="200"></textarea>
                <input type ="submit" value ="send" class="btn btn-outline-primary mt-4 float-right ">
            </div>
        </form>
    </div>

    <div class="container">
        <div class="pb-2 mt-4 mb-2 border-bottom">
            <h4>note</h4>
        </div>
        <div class="mt-1 mb-1 border-bottom">
            <p class="text-left">
                {{uploaded_message}}
            </p>
        </div>
        {% for item in textdata_list %}
        <div class="mt-1 mb-1 border-bottom">
            <p class="text-left">
                {{item}}
            </p>
        </div>
        {% endfor %}
        <div class="textdata_list"></div>
        <div id="slide" style="width: 400px; height: 200px;">
            <div id="slide-in">
                <div id="open-btn"><img src="img/open-btn.gif" width="20" height="20" style="display: none;"></div>
                <h3>開くかも</h3>
                <div id="slide-contents">
                    <p>これは開くかもしれない。開きましたか？</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}